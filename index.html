<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Jeepney Fare Planner – Dual-Origin System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #0038a8;
  --primary-light: #3a5fc0;
  --primary-dark: #00267a;
  --yellow: #fcd116;
  --red: #ce1126;
  --green: #28a745;
  --bg: #f8fafc;
  --card: #ffffff;
  --border: #e2e8f0;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
  --text: #2d3748;
  --text-light: #718096;
  --radius: 12px;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  margin: 0;
  color: var(--text);
  line-height: 1.6;
}

header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: #fff;
  padding: 1.5rem 2rem;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  gap: 1rem;
  position: relative;
  overflow: hidden;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 40%;
  height: 100%;
  background: linear-gradient(135deg, transparent 0%, rgba(206, 17, 38, 0.1) 100%);
}

header img {
  height: 60px;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
  z-index: 1;
}

.header-content {
  z-index: 1;
}

header h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
}

header small {
  font-weight: 400;
  opacity: 0.9;
  font-size: 0.9rem;
}

/* Navigation Tabs */
nav {
  background: var(--card);
  display: flex;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  position: sticky;
  top: 0;
  z-index: 100;
}

nav button {
  background: none;
  border: none;
  padding: 1rem 2rem;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-light);
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

nav button:hover {
  color: var(--primary);
}

nav button.active {
  color: var(--primary);
}

nav button.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--yellow);
  border-radius: 3px 3px 0 0;
}

/* Main Content */
main {
  padding: 2rem;
  max-width: 1400px;
  margin: 0 auto;
}

section {
  display: none;
  animation: fadeIn 0.3s ease;
}

section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Map and Panel Layout */
.fare-calculator {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

#map {
  height: 70vh;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
}

.panel {
  background: var(--card);
  padding: 1.5rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.panel-header h2 {
  margin: 0;
  font-size: 1.25rem;
  color: var(--primary);
}

/* Form Elements */
.form-group {
  margin-bottom: 1rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text);
  font-size: 0.9rem;
}

select, input {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 0.95rem;
  transition: all 0.2s;
  background: #fff;
}

select:focus, input:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(0, 56, 168, 0.1);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: #f1f5f9;
  color: var(--text);
}

.btn-secondary:hover {
  background: #e2e8f0;
}

.btn-small {
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
}

/* Fare Display */
.fare-display {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: var(--radius);
  padding: 1.5rem;
  text-align: center;
  margin-top: 1rem;
  border: 1px solid var(--border);
}

.fare-amount {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--primary);
  margin: 0.5rem 0;
  line-height: 1;
}

.fare-label {
  font-size: 0.9rem;
  color: var(--text-light);
  font-weight: 500;
}

.fare-details {
  margin-top: 1rem;
  text-align: left;
  font-size: 0.9rem;
  color: var(--text);
  background: white;
  padding: 1rem;
  border-radius: 8px;
  border-left: 3px solid var(--primary);
}

/* Search Results */
.search-results {
  max-height: 150px;
  overflow-y: auto;
  margin-top: 0.5rem;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: #fff;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.search-results div {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-bottom: 1px solid #f1f5f9;
  transition: background 0.2s;
}

.search-results div:hover {
  background: #f8fafc;
}

.search-results div:last-child {
  border-bottom: none;
}

/* Route Suggestion Tab */
.route-search-container {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  align-items: center;
}

.route-search-container input {
  flex: 1;
}

.route-count {
  color: var(--text-light);
  font-size: 0.9rem;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  background: #fff;
  box-shadow: var(--shadow);
  border-radius: var(--radius);
  overflow: hidden;
}

th, td {
  border: 1px solid var(--border);
  padding: 1rem;
  text-align: left;
  vertical-align: top;
}

th {
  background: var(--primary);
  color: #fff;
  font-weight: 600;
  position: sticky;
  top: 0;
}

tbody tr {
  transition: background 0.2s;
}

tbody tr:hover {
  background: #f8fafc;
}

/* Route Legend */
.route-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
  padding: 1rem;
  background: #f8fafc;
  border-radius: var(--radius);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 4px;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .fare-calculator {
    grid-template-columns: 1fr;
  }
  
  #map {
    height: 50vh;
  }
}

@media (max-width: 768px) {
  main {
    padding: 1rem;
  }
  
  header {
    padding: 1rem;
  }
  
  header h1 {
    font-size: 1.25rem;
  }
  
  nav button {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
  }
  
  .panel {
    padding: 1rem;
  }
  
  table {
    display: block;
    overflow-x: auto;
  }
  
  .route-legend {
    flex-direction: column;
    gap: 0.5rem;
  }
}

/* Utility Classes */
.text-center { text-align: center; }
.mb-0 { margin-bottom: 0; }
.mt-1 { margin-top: 1rem; }
.mb-1 { margin-bottom: 1rem; }
.hint {
  color: var(--text-light);
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-traditional {
  background: #e9f5ff;
  color: #0066cc;
}

.badge-modern {
  background: #f0f9ff;
  color: #0c4a6e;
}

/* Loading Animation */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<header>
  <img src="ltfrb.png" alt="LTFRB Logo">
  <div class="header-content">
    <h1>Land Transportation Franchising and Regulatory Board</h1>
    <small>Jeepney Fare Planner – Region X</small>
  </div>
</header>

<nav>
  <button id="tabFare" class="active">
    <i class="fas fa-calculator"></i> Fare Calculator
  </button>
  <button id="tabRoutes">
    <i class="fas fa-route"></i> Route Suggestion
  </button>
</nav>

<main>
  <!-- Fare Calculator Tab -->
  <section id="fareTab" class="active">
    <div class="fare-calculator">
      <div id="map"></div>
      <div class="panel">
        <div class="panel-header">
          <h2>Fare Calculation</h2>
        </div>
        
        <div class="form-group">
          <label for="pujType">Select PUJ Type</label>
          <select id="pujType">
            <option value="traditional">Traditional PUJ (₱12 + ₱1.80/km)</option>
            <option value="modern">Modern PUJ (₱15 + ₱2.20/km)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="originSearch">Search Origin (CDO only)</label>
          <input type="text" id="originSearch" placeholder="Search or click on map..." />
          <div id="originResults" class="search-results"></div>
        </div>
        
        <button id="locateBtn" class="btn btn-secondary btn-small">
          <i class="fas fa-location-arrow"></i> Use My Current Location
        </button>
        
        <div class="form-group">
          <label for="destSearch">Search Destination (CDO only)</label>
          <input type="text" id="destSearch" placeholder="Search or click on map..." />
          <div id="searchResults" class="search-results"></div>
        </div>
        
        <p class="hint">You can set origin and destination by search, pin, or GPS.</p>
        
        <div class="fare-display">
          <div class="fare-label">Estimated Fare</div>
          <div class="fare-amount" id="fare">₱0</div>
          <div id="details" class="fare-details"></div>
        </div>
        
        <button id="resetBtn" class="btn btn-secondary">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
    </div>
    
    <!-- Route Legend -->
    <div class="route-legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #0038a8;"></div>
        <span>Main Routes</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #fcd116;"></div>
        <span>Selected Route</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #16a34a;"></div>
        <span>Origin Point</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #dc2626;"></div>
        <span>Destination Point</span>
      </div>
    </div>
  </section>

  <!-- Route Suggestion Tab -->
  <section id="routeTab">
    <h2>Route Suggestion</h2>
    <div class="route-search-container">
      <input type="text" id="routeSearch" placeholder="Search routes by name, origin, or destination..." />
      <div class="route-count" id="routeCount">8 routes found</div>
    </div>
    <table id="routeTable">
      <thead>
        <tr>
          <th>Route Name</th>
          <th>Origin</th>
          <th>Destination</th>
          <th>Landmarks</th>
          <th>Distance</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Cogon Market – Westbound Bulua Terminal</td>
          <td>Cogon Market</td>
          <td>Westbound Bulua Terminal</td>
          <td>Wadhu's, Parasat, Kathryn's, Lourdes, Cathedral, KSY, Carmen Market, COC, SSS, NGCP, Campo Crossing, Dunlop, PNP, LTFRB, Banga</td>
          <td>8.0 KM</td>
        </tr>
        <tr>
          <td>Westbound Bulua Terminal – Cogon Market</td>
          <td>Westbound Bulua Terminal</td>
          <td>Cogon Market</td>
          <td>Banga, LTFRB, PNP, Dunlop, NGCP, SSS, CSC, Jollibee Vamenta, Carmen Market, KSY, Gaston Park, Pabayo Street, FICCO, Xavier, CHED, Petron Cogon, Gaisano Osmeña</td>
          <td>7.7 KM</td>
        </tr>
        <tr>
          <td>Cogon Market – Agora Terminal</td>
          <td>Cogon Market</td>
          <td>Agora Terminal</td>
          <td>Limketkai Mall, UTSP, Puregold</td>
          <td>2.3 KM</td>
        </tr>
        <tr>
          <td>Agora Terminal – Cogon Market</td>
          <td>Agora Terminal</td>
          <td>Cogon Market</td>
          <td>Corrales Ext., Gaisano Mall, Malayan, MOGCHS, CCS, Chowking DV, Xavier, Ororama Cogon</td>
          <td>4.0 KM</td>
        </tr>
        <tr>
          <td>Cogon Market – Cugman</td>
          <td>Cogon Market</td>
          <td>Cugman</td>
          <td>Limketkai, SM CDO, Nazareth, Balulang, Cugman Terminal</td>
          <td>9.5 KM</td>
        </tr>
        <tr>
          <td>Cugman – Cogon Market</td>
          <td>Cugman</td>
          <td>Cogon Market</td>
          <td>Cugman Terminal, Balulang, Nazareth, SM CDO, Limketkai, Cogon Market</td>
          <td>9.5 KM</td>
        </tr>
        <tr>
          <td>R1 Carmen (Loop)</td>
          <td>Carmen Market</td>
          <td>Carmen Market</td>
          <td>Carmen Market, KSY, Gaston Park, Pabayo Street, FICCO, Xavier, CHED, Petron Cogon, Gaisano Osmeña, Cogon Market, Limketkai, SM CDO, Nazareth, Balulang, Cugman Terminal</td>
          <td>15.2 KM</td>
        </tr>
        <tr>
          <td>R2 Carmen (Loop)</td>
          <td>Carmen Market</td>
          <td>Carmen Market</td>
          <td>Carmen Market, KSY, Gaston Park, Pabayo Street, FICCO, Xavier, CHED, Petron Cogon, Gaisano Osmeña, Cogon Market, Limketkai, SM CDO, Nazareth, Balulang, Cugman Terminal</td>
          <td>14.8 KM</td>
        </tr>
      </tbody>
    </table>
  </section>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
// ---- Tab Switching ----
const tabFare = document.getElementById('tabFare');
const tabRoutes = document.getElementById('tabRoutes');
const fareTab = document.getElementById('fareTab');
const routeTab = document.getElementById('routeTab');

tabFare.onclick = () => {
  tabFare.classList.add('active');
  tabRoutes.classList.remove('active');
  fareTab.classList.add('active');
  routeTab.classList.remove('active');
};

tabRoutes.onclick = () => {
  tabRoutes.classList.add('active');
  tabFare.classList.remove('active');
  routeTab.classList.add('active');
  fareTab.classList.remove('active');
};

// ---- Route Search Filter ----
document.getElementById('routeSearch').addEventListener('input', function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll('#routeTable tbody tr');
  let visibleCount = 0;
  
  rows.forEach(r => {
    const text = r.textContent.toLowerCase();
    const isVisible = text.includes(filter);
    r.style.display = isVisible ? '' : 'none';
    if (isVisible) visibleCount++;
  });
  
  document.getElementById('routeCount').textContent = `${visibleCount} route${visibleCount !== 1 ? 's' : ''} found`;
});

// ---- Fare Calculator Logic ----
const ROUTES = {
  "cogon-to-bulua": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/cogon-to-bulua.geojson",
  "bulua-to-cogon": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/bulua-to-cogon.geojson",
  "cogon-agora(lapasan)": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/cogon-agora(lapasan).geojson",
  "agora(lapasan)-cogon": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/agora(lapasan)-cogon.geojson",
  "cogon-cugman": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/cogon-cugman.geojson",
  "cugman-cogon": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/cugman-cogon.geojson",
  "r1-carmen(loop)": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/r1-carmen(loop).geojson",
  "r2-carmen(loop)": "https://gitptvspwbxdrlsebwpq.supabase.co/storage/v1/object/public/geojson/r2-carmen(loop).geojson"
};

const PUJ_RATES = {
  traditional: { base: 12.00, perKm: 1.80 },
  modern: { base: 15.00, perKm: 2.20 }
};

const BASE_KM = 4.0;
const CDO_BBOX = [124.5800, 8.3900, 124.7200, 8.5200];
let map, routeLayers = [], routeData = {}, startSnap = null, endSnap = null;
let startMarker, endMarker, sliceLayer;
let currentRates = PUJ_RATES.traditional;

function peso(v) { return '₱' + Math.round(v).toLocaleString(); }
function km(v) { return v.toFixed(2) + ' km'; }

async function init() {
  map = L.map('map').setView([8.48, 124.64], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  
  // Create a layer group for all routes
  const routeGroup = L.layerGroup().addTo(map);
  
  // Define colors for different routes
  const routeColors = {
    "cogon-to-bulua": "#0038a8",
    "bulua-to-cogon": "#0038a8",
    "cogon-agora(lapasan)": "#0038a8",
    "agora(lapasan)-cogon": "#0038a8",
    "cogon-cugman": "#3a5fc0",
    "cugman-cogon": "#3a5fc0",
    "r1-carmen(loop)": "#ce1126",
    "r2-carmen(loop)": "#ce1126"
  };
  
  for (const [key, path] of Object.entries(ROUTES)) {
    try {
      const res = await fetch(path);
      const data = await res.json();
      routeData[key] = data;
      const color = routeColors[key] || '#0038a8';
      const layer = L.geoJSON(data, { 
  style: { 
    color: color, 
    weight: 4, 
    opacity: 0.7 
  } 
}); // <-- no addTo(map)
routeLayers.push(layer);
      routeLayers.push(layer);
    } catch (error) {
      console.error(`Error loading route ${key}:`, error);
    }
  }
  
  document.getElementById('pujType').addEventListener('change', e => {
    currentRates = PUJ_RATES[e.target.value];
    if (startSnap && endSnap) computeFare();
  });
  
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('locateBtn').addEventListener('click', useGPS);
  document.getElementById('originSearch').addEventListener('input', e => searchLocation(e, 'origin'));
  document.getElementById('destSearch').addEventListener('input', e => searchLocation(e, 'dest'));
  
  map.on('click', e => {
    const point = turf.point([e.latlng.lng, e.latlng.lat]);
    const nearest = findNearestRoute(point);
    if (!nearest) return alert('No nearby route found.');
    if (!startSnap) {
      startSnap = nearest;
      drawMarker(startSnap, 'start');
    } else {
      endSnap = nearest;
      drawMarker(endSnap, 'end');
      computeFare();
    }
  });
}

function findNearestRoute(point) {
  let nearest = null, minDist = Infinity;
  for (const data of Object.values(routeData)) {
    const geom = data.features ? data.features[0].geometry : data.geometry;
    const coords = (geom.type === 'MultiLineString' ? geom.coordinates.flat() : geom.coordinates);
    const line = turf.lineString(coords);
    const snap = turf.nearestPointOnLine(line, point);
    if (snap.properties.dist < minDist) {
      minDist = snap.properties.dist;
      nearest = snap;
      nearest.line = line;
    }
  }
  return nearest;
}

function drawMarker(snap, type) {
  const c = snap.geometry.coordinates;
  if (type === 'start') {
    if (startMarker) map.removeLayer(startMarker);
    startMarker = L.circleMarker([c[1], c[0]], {
      radius: 8,
      fillColor: '#16a34a',
      color: '#fff',
      weight: 2,
      fillOpacity: 1
    }).addTo(map).bindTooltip('Origin');
  } else {
    if (endMarker) map.removeLayer(endMarker);
    endMarker = L.circleMarker([c[1], c[0]], {
      radius: 8,
      fillColor: '#dc2626',
      color: '#fff',
      weight: 2,
      fillOpacity: 1
    }).addTo(map).bindTooltip('Destination');
  }
}

function computeFare() {
  if (!startSnap || !endSnap) return;
  const sliced = turf.lineSlice(startSnap, endSnap, endSnap.line);
  const distKm = turf.length(sliced, { units: 'kilometers' });
  const rates = currentRates;
  const excess = Math.max(0, distKm - BASE_KM) * rates.perKm;
  const fare = distKm <= BASE_KM ? rates.base : rates.base + excess;
  const total = Math.round(fare);
  
  document.getElementById('fare').textContent = peso(total);
  
  const pujType = rates === PUJ_RATES.traditional ? 'Traditional' : 'Modern';
  const pujBadge = `<span class="badge badge-${rates === PUJ_RATES.traditional ? 'traditional' : 'modern'}">${pujType}</span>`;
  
  document.getElementById('details').innerHTML = `
    PUJ Type: ${pujBadge}<br>
    Distance: <b>${km(distKm)}</b><br>
    First ${BASE_KM} km: ₱${rates.base.toFixed(2)}<br>
    After ${BASE_KM} km: ${(Math.max(0, distKm - BASE_KM)).toFixed(2)} km × ₱${rates.perKm.toFixed(2)} = ₱${excess.toFixed(2)}<br>
    <small>Rounded to the nearest peso.</small>`;
  
  if (sliceLayer) map.removeLayer(sliceLayer);
  sliceLayer = L.geoJSON(sliced, { style: { color: '#0038a8', weight: 6 } }).addTo(map);

}

function resetAll() {
  if (startMarker) map.removeLayer(startMarker);
  if (endMarker) map.removeLayer(endMarker);
  if (sliceLayer) map.removeLayer(sliceLayer);
  startMarker = endMarker = sliceLayer = null;
  startSnap = endSnap = null;
  document.getElementById('fare').textContent = '₱0';
  document.getElementById('details').innerHTML = '';
  document.getElementById('originSearch').value = '';
  document.getElementById('destSearch').value = '';
  document.getElementById('originResults').innerHTML = '';
  document.getElementById('searchResults').innerHTML = '';
}

function useGPS() {
  if (!navigator.geolocation) {
    alert("GPS not supported");
    return;
  }
  
  navigator.geolocation.getCurrentPosition(pos => {
    const point = turf.point([pos.coords.longitude, pos.coords.latitude]);
    const nearest = findNearestRoute(point);
    if (!nearest) return alert('No nearby route found.');
    startSnap = nearest;
    drawMarker(startSnap, 'start');
    map.setView([pos.coords.latitude, pos.coords.longitude], 15);
  }, () => alert("Unable to retrieve location."));
}

function searchLocation(e, type) {
  const q = e.target.value.trim();
  const resultDiv = (type === 'origin' ? document.getElementById('originResults') : document.getElementById('searchResults'));
  resultDiv.innerHTML = '';
  if (q.length < 3) return;
  
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ' Cagayan de Oro City')}&bounded=1&limit=5&viewbox=${CDO_BBOX.join(',')}`;
  
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (!data.length) {
        resultDiv.innerHTML = '<div>No results in CDO.</div>';
        return;
      }
      
      data.forEach(loc => {
        const div = document.createElement('div');
        div.textContent = loc.display_name;
        div.onclick = () => {
          resultDiv.innerHTML = '';
          const point = turf.point([+loc.lon, +loc.lat]);
          const nearest = findNearestRoute(point);
          if (!nearest) return alert('No nearby route found.');
          
          if (type === 'origin') {
            startSnap = nearest;
            drawMarker(startSnap, 'start');
            map.setView([+loc.lat, +loc.lon], 15);
          } else {
            endSnap = nearest;
            drawMarker(endSnap, 'end');
            map.setView([+loc.lat, +loc.lon], 15);
            computeFare();
          }
        };
        resultDiv.appendChild(div);
      });
    });
}

init();
</script>
</body>
</html>